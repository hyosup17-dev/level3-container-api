name: Deploy API to ECS

# 1. 언제 실행할 것인가?
# 'main' 브랜치에 'push'가 일어났을 때
on:
  push:
    branchs: ["main"]

# 2. GitHub Secrets를 이 워크플로우에서 사용할 수 있도록 변수화
env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY_URL: ${{ secrets.ECR_REPOSITORY_URL }}
  ECS_CLUSTER_NAME: ${{ secrets.ECS_CLUSTER_NAME }}
  ECS_SERVICE_NAME: ${{ secrets.ECS_SERVICE_NAME }}

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest # Linux 가상 머신에서 실행

    steps: 
      # --- 1. 코드 가져오기 ---
      - name: Checkout
        uses: actions/checkout@v4

      # --- 2. AWS 자격 증명 설정 ---
      # (1단계에서 만든 IAM 사용자, 2단계의 GitHub Secrets 사용)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # --- 3. ECR 로그인 ---
      # (Phase 4의 'aws ecr get-login-password...' 자동화)
      - name: Login and Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        id: login-ecr

      # --- 4. Docker 이미지 빌드, 태그, 푸시 ---
      # (Phase 4의 'docker build', 'tag', 'push' 자동화)
      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        uses: docker/build-push-action@v5
        with:
          context: ./app # 'app' 폴더를 빌드
          push: true
          # :latest 태그를 붙여서 ECR_REPOSITORY_URL로 푸시
          tags: ${{ env.ECR_REPOSITORY_URL }}:latest

      # --- 5. ECS 서비스 강제 재배포 ---
      # (Phase 4의 'ECS 콘솔 클릭' 자동화)
      - name: Force new deployment on ECS
        run: |
          echo "Forcing new deployment for service: ${{ env.ECS_SERVICE_NAME }} in cluster: ${{ env.ECS_CLUSTER_NAME }}"
          aws ecs update-service --cluster ${{ env.ECS_CLUSTER_NAME }} --service ${{ env.ECS_SERVICE_NAME }} --force-new-deployment